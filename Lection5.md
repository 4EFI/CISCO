# IPv4 (Продолжение)

## Routing (Маршрутизация)

Рассмотрим следующую схему

Есть три маршрутизатора, к каждому подключен коммутатор, к каждому коммутатору подключены по два узла.

<p style="text-align: left"><img src=res/5_1.png width="500px"/></p>

Должны указать каждую подсеть:

<p style="text-align: left"><img src=res/5_2.png width="500px"/></p>

Берем адрес сети и IP-адрес хоста, накладываем на них маску и сравниваем сетевые части. Если сетевые части совпадают, значит, что хост принадлежит этой сети.

На интерфейс роутера обычно назначается первый или последний доступный узел (можно любой, но так удобно).

### A -> С

Узел A понимает, что нужно провзаимодействовать с узлом C, берет свой IP-адрес и свою маску. Берет чужой IP-адрес. Накладывает **свою маску** на свой IP-адрес и на чужой. Если сетевые части разные, тогда узлы в разных подсетях. Значит нужно искать роутер.

Отправляет на DefaultGateway (на роутер R1 192.168.0.1).

Нужно связать роутера R1, R2 и R3. Адреса можно выбрать следующим образом (как пример): 

<p style="text-align: left"><img src=res/5_3.png width="400px"/></p>

Если схема большая: 10.x.y.x|y

<p style="text-align: left"><img src=res/5_4.png width="600px"/></p>

Нарисуем таблицу маршрутизации (подпишем интерфейсы для R1: R1-S1 (fa0/0), R1-R2 (fa0/1), R1-R2 (fa0/2)):

Следующие сети появляются автоматически:

<p style="text-align: left"><img src=res/5_5.png width="500px"/></p>

Нужно добавить еще две сети, тут уже нельзя указать интерфейс, нужно указать IP-адрес следующего перехода (IP-адреса R2 и R3):

<p style="text-align: left"><img src=res/5_6.png width="500px"/></p>

Что означает первая колонка в таблице. Означает откуда информация появилась в RIB (Routing Information Base):
* C - Connected
* S - Static (Статический маршрут, кто-то вручную его ввел)

Что делать с этой таблицей. Мы должны найти наилучшую запись в этой таблице при отправке. Просматриваем таблицу, ищем совпадение сети и если необходимо, проходимся по таблице еще раз (при отправке от A к C нужно будет отправить на другой роутер R2).

Адрес узла C: 192.168.2.2

<p style="text-align: left"><img src=res/5_7.png width="500px"/></p>

### Ситуации при анализе таблицы маршрутизации

Может быть ситуация, когда у двух строк в таблице совпадет сеть с сетью узла. 

<p style="text-align: left"><img src=res/5_8.png width="500px"/></p>

В это случае работает правило ```НАИБОЛЕЕ ДЛИННОЙ МАСКИ``` только среди тех, что подходят под сеть получателя.

#### AD (Administrative Distance)

Administrative Distance (AD) - это показатель приоритета маршрута, который используется маршрутизаторами для выбора оптимального пути передачи данных. 

!!! Чем ниже AD, тем выше приоритет маршрута.

* C (Connected): Маршруты с ```AD=0``` - это маршруты к прямо подключенным сетям. Они всегда имеют самый высокий приоритет.
* S (Static): Статические маршруты с ```AD=1``` - это маршруты, которые конфигурируются вручную администратором. Они имеют более низкий приоритет, чем прямо подключенные сети.
* OSPF (Оpen Shortest Path First) - это протокол внутренней маршрутизации. Маршруты, полученные от OSPF, имеют ```AD=110```.
* RIP (Routing Information Protocol) - это протокол внутренней маршрутизации. Маршруты, полученные от RIP, имеют ```AD=120```.

### Зацикливание пакета

В заголовке есть поле```TTL```, которе позволяет **убрать** зацикливание. TTL уменьшается при каждом ```хопе``` (при каждом переходе).

! Тонкий момент: мы знаем путь от отправителя до получателя. Мы ничего не можем сказать как трафик идет к нам.

### Между R2 и R3 не Ethernet

MTU (Maximum Transfer Unit) = 1000 ```меньше``` чем у Ethernet (MTU = 1500).

Если узел отправляет 1500 байт между R2 и R3:
* Можно отбросить пакет
* Можно разделить пакет на несколько фрагментов (```Фрагментация```)

## Фрагментация

В заголовке участвует идентификатор, будет стоять ```одно и то же число``` при фрагментации (одно поле ID).

Еще используются поля FragmentOffset и флаги:
* res. - первый флаг зарезервирован
* DF (Do not Fragment) - отключить фрагментацию 
* MF (More Fragments) - означает, есть ли еще за ним фрагменты. ```0``` означает, что фрагмент последний

Сборка пакета лежит на получателе.

Что если часть пакета теряется? Есть определенные timeout, если все не доходит за это время, то буфер сбрасывается. **Теряем пакет целиком!**

### Тонкие моменты
* Заголовок транспортного уровня (TCP/UDP/...) будет **только в одном** фрагменте
* В реальность фрагменты **НЕ одинаковой длины**. Проходит максимальной допустимой длины, затем остаток (в нашем случае 1000 и 500 байт, не по 750 байт)