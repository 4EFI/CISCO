# VLAN (Virtual Local Area Network)

В условиях растущей компании неизменно увеличивается количество отделов. Это влечёт за собой соответствующий рост численности коммутаторов в сети. В результате часто остаётся множество незадействованных портов, что ведёт к неэффективному использованию ресурсов.

## Решение проблемы избыточных коммутаторов
  
Вместо использования множества отдельных коммутаторов, можно применить одно крупное шасси, выполняющее роль единого физического коммутатора. Затем, это устройство разбивается на несколько логических коммутаторов, отвечающих требованиям конкретных отделов.

## Преимущества использования VLAN

1. Гибкость.  
   Каждый логический коммутатор может быть легко изменён в зависимости от меняющихся потребностей отдела.

2. Удалённое управление.  
   Перевод сотрудников между отделами становится более простым, поскольку это требует лишь перенастройки логического коммутатора, а не физического вмешательства.

## Проблемы и их решения
  
При нехватке портов добавляется новый коммутатор. Однако, чтобы сохранить целостность логических коммутаторов, необходимо будет соединить каждый логический блок обоих коммутаторов.

<p style="text-align: left"><img src=res/12_1.png width="500px"/></p>

Чтобы избежать сложных и многочисленных соединений, можно объединить два больших коммутатора с помощью специального соединения, известного как ```trunk```. Этот подход обеспечивает поддержку нескольких VLAN через одно физическое соединение, сохраняя логическую сегментацию и сетевую эффективность.

### Протокол Trunk 802.1Q

Технология Trunk 802.1Q является основополагающей для организации виртуальных локальных сетей (VLAN) в современных сетевых инфраструктурах. В основе этого протокола лежит добавление специального тега длиной 4 байта, который вставляется между заголовком Ethernet-фрейма и данными. Этот тег содержит несколько ключевых полей, каждое из которых выполняет свою определённую функцию.

#### Поля заголовка 802.1Q

<p style="text-align: left"><img src=res/12_2.png width="600px"/></p>

1. QoS (Quality of Service) — 3 бита: 
  Поле QoS используется для определения качества обслуживания. Оно позволяет выставлять приоритеты трафика, обеспечивая более высокое качество передачи данных для критических приложений и сервисов.

2. CFI (Canonical Format Indicator) — 1 бит: 
  Поле CFI указывает на порядок битов в MAC-адресах. Оно помогает в обеспечении совместимости между различными сетевыми технологиями, такими как Ethernet и Token Ring.

3. VID (VLAN Identifier) — 12 бит: 
  Это поле назначает VLAN, к которой относится кадр. Возможны 4096 (2^12) уникальных идентификаторов VLAN, но 0 и 4095 зарезервированы для специальных целей.

4. Type — 16 бит: 
  Поле Type идентифицирует тип протокола, который следует за заголовком. Для 802.1Q значение этого поля всегда равно 0x8100, указывая на наличие VLAN-тега.

### Q-in-Q: Технология Двойного Тегирования VLAN

Технология Q-in-Q, или двойное тегирование VLAN, представляет собой расширение стандарта 802.1Q, предназначенное для повышения гибкости и масштабируемости сетевых решений. Эта технология позволяет внедрять дополнительные уровни сегментации сети, что особенно полезно для поставщиков услуг и сложных корпоративных сетей.

#### Основная идея Q-in-Q

Q-in-Q позволяет инкапсулировать трафик одной или нескольких VLAN во внешнюю VLAN, добавляя дополнительный внешний тег 802.1Q. Это означает, что кадр, который уже содержит тег VLAN, получает ещё один тег, превращая его в "двойной тег".

#### Как работает Q-in-Q

- Внешний Тег (Outer Tag): 
 Этот тег добавляется поставщиком услуг и содержит идентификатор Service Provider VLAN (S-VLAN).

- Внутренний Тег (Inner Tag): 
 Это стандартный тег, который используется для нормального сетевого трафика клиента и включает Customer VLAN (C-VLAN).

Когда пакет отправляется через сеть, проходя через коммутаторы и маршрутизаторы провайдера, внешний тег используется для маршрутизации пакетов внутри сети провайдера, тогда как внутренний тег остаётся неизменным и используется для маршрутизации внутри сети клиента.


# STP (Spanning Tree Protocol)

Spanning Tree Protocol, или STP, является критически важным протоколом в сетевых технологиях, предназначенным для предотвращения петель в сетях Ethernet, что часто происходит на уровне доступа (Access). Без эффективного управления петлями могут возникнуть проблемы, такие как широковещательные штормы, которые значительно ухудшают производительность сети.

## Основная цель STP

STP предотвращает образование петель, создавая логическое дерево с единственным корнем, известным как корневой коммутатор (root bridge). Оно выполняется путем управления состояниями портов коммутаторов и временного блокирования лишних путей.

## Архитектура сети

Сети обычно структурированы вокруг трех уровней:

- Core (L3): Основной уровень, где обрабатывается маршрутизация IP-трафика.
- Aggregation: Промежуточный уровень, обеспечивающий соединение между Core и Access уровнями.
- Access (L2): Уровень доступа, где подключены конечные устройства, и где наиболее вероятно образование петель.

## Как работает STP

<p style="text-align: left"><img src=res/12_3.png width="600px"/></p>

1. Выбор корня (```Root Bridge```): 
  Все коммутаторы обмениваются BPDU (Bridge Protocol Data Units) для выбора корневого коммутатора. Корневой коммутатор — это устройство с наименьшим идентификатором мостового устройства (Bridge ID).

2. Определение кратчайших путей: 
  После выбора корня, каждый коммутатор определяет свой кратчайший путь до корневого коммутатора и активирует назначенный порт (```Root Port```) для передачи пакетов.

3. Назначение портов (```Designated Ports```): 
  На каждом сегменте сети назначается Designated Port, который является оптимальным путем к корню.

4. Блокировка избыточных путей: 
  Любые дополнительные пути, кроме Root и Designated портов, блокируются, чтобы предотвратить петли. Эти порты остаются в состоянии "заблокированы" и не обрабатывают и не передают трафик.

### Углубимся

#### Выбор корня (Root Bridge) в STP

В процессе настройки STP каждый коммутатор в сети изначально считает себя корневым коммутатором. Для обеспечения корректной работы сети и предотвращения петель важен выбор единственного корневого коммутатора, и этот процесс происходит через обмен BPDU (Bridge Protocol Data Units).

##### Компоненты BPDU и BID

Каждый коммутатор в своей BPDU включает уникальный идентификатор мостового устройства (Bridge ID, или BID), который состоит из двух частей:

1. Priority (Приоритет) — 2 байта: 
  Уровень приоритета, задаваемый администратором сети. По умолчанию этот показатель равен 32768, но его можно изменить для увеличения приоритета устройства.

2. MAC-адрес — 6 байт: 
  Уникальный MAC-адрес коммутатора. Он используется как часть BID, чтобы обеспечить уникальность идентификатора, если приоритеты равны.

#### Сравнение и выбор Root Bridge

- Начало Процесса: 
  Каждый коммутатор отправляет свои BPDU в сеть, указывая свой BID, считая себя корнем.

- Сравнение BPDU: 
  Коммутатор сравнивает свой собственный BID с BID, полученным от соседних коммутаторов. Коммутатор с наименьшим BID становится корневым коммутатором (Root Bridge). Это тот коммутатор, у которого либо ниже приоритет, либо, при одинаковом приоритете, более низкий MAC-адрес.

### Root Path Cost (RPC)

- Определение RPC: 
 Для корневого коммутатора Root Path Cost (RPC) равен 0, так как это базовая точка отсчёта. RPC показывает стоимость пути до корня от любого устройства в сети, увеличиваясь, учитывая пропускную способность и расстояние от корня.

### Выбор Designated портов в STP

Designated порт — это порт, который обеспечивает наилучший путь к корневому коммутатору для сегмента сети. Выбор Designated порта основан на следующих приоритетах:

1. Root Path Cost (RPC): 
  В первую очередь, выбирается порт с наименьшим Root Path Cost. Это стоимость пути от порта до корневого коммутатора. Меньшая стоимость означает более предпочтительный и оптимальный путь.

2. Bridge ID (BID): 
  Если два порта имеют одинаковую стоимость пути до корня, тогда сравнивается Bridge ID коммутаторов, к которым принадлежат эти порты. Порт на коммутаторе с меньшим BID становится Designated.

3. Port ID (PID): 
  Если и BID одинаковы, тогда окончательное решение принимается на основе Port ID. Это уникальный идентификатор портов на коммутаторе. Меньший PID предпочтителен и считается лучше, поскольку позволяет избежать ничейных ситуаций. Берется порт соседа!

## Таймеры в STP

STP построен на таймерах. Если что-то изменилось, в течение 20 секунд ждем. 

Blocking (сколь угодно долгие)
Listening (15s) - переходные
Learning (15s)
Forwarding (сколь угодно долгие)

## RSTP (Rapid Spanning Tree Protocol)

Rapid Spanning Tree Protocol (RSTP) был разработан как усовершенствование стандартного STP с целью ускорения процесса согласования топологии сети и минимизации времени, необходимого для восстановления сетевого соединения после сбоев или изменения топологии. Работает незамедлительно без таймеров.

#### Процесс Proposal и Agreement

1. Proposal (Предложение): 
  RSTP использует концепцию Fast Transition, где корневой коммутатор (Root Bridge) отправляет сообщения Proposal через свои порты. Эти сообщения указывают на намерение установить данный порт как часть активной сети.

2. Блокировка портов: 
  Каждый коммутатор, получивший Proposal, временно блокирует все другие порты, кроме того, через который он получил сообщение.

3. Agreement (Согласование): 
  После получения Proposal коммутаторы отправляют в ответ сообщение Agreement через тот же порт. Agreement указывает на приемлемость предложенного состояния сети, подтверждая установление связи через предлагаемый путь.

4. Быстрое переключение портов: 
  После получения Agreement, коммутаторы немедленно переводят пути в активное состояние, минуя традиционные временные задержки STP.

## PVST (Per-VLAN Spanning Tree)

Per-VLAN Spanning Tree (PVST) — это протокол, используемый в сетевых технологиях Cisco для управления сетевой топологией индивидуально для каждой VLAN. Это означает, что для каждой VLAN создаётся своё собственное независимое spanning tree. Это позволяет более гибко управлять трафиком и балансировать нагрузку в сетях с множеством VLAN.

## MST или MSTP (Multiple Spanning Tree Protocol)

Multiple Spanning Tree Protocol (MSTP) — это продвинутая версия протокола для управления топологией сетей, позволяющая одной топологии охватывать несколько VLAN. MSTP объединяет преимущества Rapid Spanning Tree Protocol (RSTP) и учитывает взаимодействие с VLAN, обеспечивая более эффективное управление и оптимизацию сетевой инфраструктуры, объединяя VLAN'ы в группы (```instance```), для каждого instance, создавая отдельное дерево.